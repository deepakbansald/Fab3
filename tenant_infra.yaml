---
  - name: "Building multipod Infra Tenant policy for Fab3"
    hosts: apic1
    connection: local
    gather_facts: no
    tasks:
      - name: "Creating Multipod l3out "
        aci_rest:
         hostname: "{{hostname}}"
         username: "{{username}}"
         password: "{{password}}"
         validate_certs: false
         method: post
         path: /api/mo/uni/tn-infra/.json
         content:
           l3extOut:
             attributes:
               name: multipod
      - name: "Associating Domain to L3out Multipod"
        aci_rest:
         hostname: "{{hostname}}"
         username: "{{username}}"
         password: "{{password}}"
         validate_certs: false
         method: post
         path: /api/mo/uni/tn-infra/out-multipod/.json
         content:
           l3extRsL3DomAtt:
             attributes:
                 tDn: uni/l3dom-Multipod-L3_1
      - name: "Associating VRF overlay-1 to L3out Multipod"
        aci_rest:
         hostname: "{{hostname}}"
         username: "{{username}}"
         password: "{{password}}"
         validate_certs: false
         method: post
         path: /api/mo/uni/tn-infra/out-multipod/.json
         content:
           l3extRsEctx:
             attributes:
                 tnFvCtxName: overlay-1
      - name: "Creating node profile for spine:201,202 and Pod2-spine"
        aci_rest:
         hostname: "{{hostname}}"
         username: "{{username}}"
         password: "{{password}}"
         validate_certs: false
         method: post
         path: /api/mo/uni/tn-infra/out-multipod/.json
         content:
           l3extLNodeP:
             attributes:
                 name: bSpine
      - name: "creating OSPF profile in multipod"
        aci_rest:
         hostname: "{{hostname}}"
         username: "{{username}}"
         password: "{{password}}"
         validate_certs: false
         method: post
         path: /api/mo/uni/tn-infra/out-multipod/.json
         content:
           ospfExtP:
             attributes:
                 areaCost: "1"
                 areaCtrl: redistribute,summary
                 areaId: backbone
                 areaType: regular
      - name: "creating BGP profile in multipod"
        aci_rest:
         hostname: "{{hostname}}"
         username: "{{username}}"
         password: "{{password}}"
         validate_certs: false
         method: post
         path: /api/mo/uni/tn-infra/out-multipod/.json
         content:
           bgpExtP:
             attributes:
                 descr: " "
      - name: "Creating Router-Id for Node 202 "
        aci_rest:
               hostname: "{{hostname}}"
               username: "{{username}}"
               password: "{{password}}"
               validate_certs: false
               method: post
               path: /api/mo/uni/tn-infra/out-multipod/lnodep-bSpine/.json
               content:
                   l3extRsNodeL3OutAtt:
                     attributes:
                       rtrId: 172.16.100.202
                       tDn: topology/pod-1/node-202
      - name: "Creating Router-Id for Node 201 "
        aci_rest:
               hostname: "{{hostname}}"
               username: "{{username}}"
               password: "{{password}}"
               validate_certs: false
               method: post
               path: /api/mo/uni/tn-infra/out-multipod/lnodep-bSpine/.json
               content:
                   l3extRsNodeL3OutAtt:
                     attributes:
                       rtrId: 172.16.100.201
                       tDn: topology/pod-1/node-201
      - name: "Creating Router-Id for  node-1201 "
        aci_rest:
               hostname: "{{hostname}}"
               username: "{{username}}"
               password: "{{password}}"
               validate_certs: false
               method: post
               path: /api/mo/uni/tn-infra/out-multipod/lnodep-bSpine/.json
               content:
                   l3extRsNodeL3OutAtt:
                     attributes:
                       rtrId: 172.16.200.201
                       tDn: topology/pod-2/node-1201
      - name: "Creating loopback-Id for Node 202 "
        aci_rest:
               hostname: "{{hostname}}"
               username: "{{username}}"
               password: "{{password}}"
               validate_certs: false
               method: post
               path: /api/mo/uni/tn-infra/out-multipod/lnodep-bSpine/rsnodeL3OutAtt-[topology/pod-1/node-202]/.json
               content:
                   l3extLoopBackIfP:
                     attributes:
                       rn: lbp-[172.16.100.202]
      - name: "Creating loopback-Id for Node 201 "
        aci_rest:
               hostname: "{{hostname}}"
               username: "{{username}}"
               password: "{{password}}"
               validate_certs: false
               method: post
               path: /api/mo/uni/tn-infra/out-multipod/lnodep-bSpine/rsnodeL3OutAtt-[topology/pod-1/node-201]/.json
               content:
                   l3extLoopBackIfP:
                     attributes:
                       rn: lbp-[172.16.100.201]
      - name: "Creating loopback-Id for Node 1201 "
        aci_rest:
               hostname: "{{hostname}}"
               username: "{{username}}"
               password: "{{password}}"
               validate_certs: false
               method: post
               path: /api/mo/uni/tn-infra/out-multipod/lnodep-bSpine/rsnodeL3OutAtt-[topology/pod-2/node-1201]/.json
               content:
                   l3extLoopBackIfP:
                     attributes:
                       rn: lbp-[172.16.200.201]
      - name: "Fabric external control peering checkbox mark for node 202 "
        aci_rest:
               hostname: "{{hostname}}"
               username: "{{username}}"
               password: "{{password}}"
               validate_certs: false
               method: post
               path: /api/mo/uni/tn-infra/out-multipod/lnodep-bSpine/rsnodeL3OutAtt-[topology/pod-1/node-202]/.json
               content:
                   l3extInfraNodeP:
                     attributes:
                       descr: ""
      - name: "Fabric external control peering checkbox mark for node 201 "
        aci_rest:
               hostname: "{{hostname}}"
               username: "{{username}}"
               password: "{{password}}"
               validate_certs: false
               method: post
               path: /api/mo/uni/tn-infra/out-multipod/lnodep-bSpine/rsnodeL3OutAtt-[topology/pod-1/node-201]/.json
               content:
                   l3extInfraNodeP:
                     attributes:
                       descr: ""
      - name: "Fabric external control peering checkbox mark for node 1201  "
        aci_rest:
               hostname: "{{hostname}}"
               username: "{{username}}"
               password: "{{password}}"
               validate_certs: false
               method: post
               path: /api/mo/uni/tn-infra/out-multipod/lnodep-bSpine/rsnodeL3OutAtt-[topology/pod-2/node-1201]/.json
               content:
                   l3extInfraNodeP:
                     attributes:
                       descr: ""
      - name: "Creating Logical interface profile on L3out Multipod"
        aci_rest:
                 hostname: "{{hostname}}"
                 username: "{{username}}"
                 password: "{{password}}"
                 validate_certs: false
                 method: post
                 path: /api/mo/uni/tn-infra/out-multipod/lnodep-bSpine/.json
                 content:
                     l3extLIfP:
                       attributes:
                         name: portIf
      - name: "Creating Sub interfaces on Spine interface node 202"
        aci_rest:
               hostname: "{{hostname}}"
               username: "{{username}}"
               password: "{{password}}"
               validate_certs: false
               method: post
               path: /api/mo/uni/tn-infra/out-multipod/lnodep-bSpine/lifp-portIf/.json
               content:
                   l3extRsPathL3OutAtt:
                     attributes:
                       tDn: topology/pod-1/paths-202/pathep-[eth1/16]
                       addr: 172.16.11.2/30
                       encap: vlan-4
                       encapScope: local
                       ifInstT: sub-interface
                       ipv6Dad: enabled
                       mtu: inherit
      - name: "Creating Sub interfaces on Spine interface node 1201"
        aci_rest:
                 hostname: "{{hostname}}"
                 username: "{{username}}"
                 password: "{{password}}"
                 validate_certs: false
                 method: post
                 path: /api/mo/uni/tn-infra/out-multipod/lnodep-bSpine/lifp-portIf/.json
                 content:
                     l3extRsPathL3OutAtt:
                       attributes:
                         tDn: topology/pod-2/paths-1201/pathep-[eth1/16]
                         addr:  172.16.12.2/30
                         encap: vlan-4
                         encapScope: local
                         ifInstT: sub-interface
                         ipv6Dad: enabled
                         mtu: inherit
      - name: "Creating Sub interfaces on Spine interface node 201"
        aci_rest:
                 hostname: "{{hostname}}"
                 username: "{{username}}"
                 password: "{{password}}"
                 validate_certs: false
                 method: post
                 path: /api/mo/uni/tn-infra/out-multipod/lnodep-bSpine/lifp-portIf/.json
                 content:
                     l3extRsPathL3OutAtt:
                       attributes:
                         tDn: topology/pod-1/paths-201/pathep-[eth1/16]
                         addr: 172.16.10.2/30
                         encap: vlan-4
                         encapScope: local
                         ifInstT: sub-interface
                         ipv6Dad: enabled
                         mtu: inherit
      - name: "Creating Sub interfaces on Spine interface node 201"
        aci_rest:
                   hostname: "{{hostname}}"
                   username: "{{username}}"
                   password: "{{password}}"
                   validate_certs: false
                   method: post
                   path: /api/mo/uni/tn-infra/out-multipod/.json
                   content:
                       bgpRtTargetInstrP:
                         attributes:
                           descr: ""
      - name: "Creating ospf interface profile for multipod"
        aci_rest:
                   hostname: "{{hostname}}"
                   username: "{{username}}"
                   password: "{{password}}"
                   validate_certs: false
                   method: post
                   path: /api/mo/uni/tn-infra/.json
                   content:
                      "ospfIfPol": {
                        "attributes": {
                          "cost": "unspecified",
                          "ctrl": "mtu-ignore",
                          "deadIntvl": "40",
                          "helloIntvl": "10",
                          "name": "multipod",
                          "nameAlias": "",
                          "nwT": "p2p",
                          "ownerKey": "",
                          "ownerTag": "",
                          "pfxSuppress": "inherit",
                          "prio": "1",
                          "rexmitIntvl": "5",
                          "xmitDelay": "1"
                            }
                        }

      - name: "assigning OSPF interface profile to L3out interface profile"
        aci_rest:
             hostname: "{{hostname}}"
             username: "{{username}}"
             password: "{{password}}"
             validate_certs: false
             method: post
             path: /api/mo/uni/tn-infra/out-multipod/lnodep-bSpine/lifp-portIf/ospfIfP/.json
             content:
                              "ospfIfP": {
                                "attributes": {
                                  "authKeyId": "1",
                                  "authType": "none",
                                  "name": ""
                                },
                                "children": [{
                                  "ospfRsIfPol": {
                                    "attributes": {
                                      "rn": "rsIfPol",
                                      "tnOspfIfPolName": "multipod",
                                       }
                                     }
                                   }]
                                }
      - name: "Creating external EPG for Multipod l3out"
        aci_rest:
           hostname: "{{hostname}}"
           username: "{{username}}"
           password: "{{password}}"
           validate_certs: false
           method: post
           path: /api/mo/uni/tn-infra/out-multipod/.json
           content:
                "l3extInstP": {
                    "attributes": {
                      "childAction": "",
                      "floodOnEncap": "disabled",
                      "name": "multipod",
                      "prefGrMemb": "exclude" },
                                  "children": [{
                                    "l3extSubnet": {
                                      "attributes": {
                                        "aggregate": "",
                                        "ip": "0.0.0.0/0",
                                        "name": "",
                                        "nameAlias": "",
                                        "scope": "import-security"
                                      }
                                    }
                                  }, {
                                    "fvRsCustQosPol": {
                                      "attributes": {
                                        "childAction": "",
                                        "rn": "rscustQosPol",
                                        "tnQosCustomPolName": ""
                                      }
                                    }
                                  }]
                                }
